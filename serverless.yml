service: cad-backend-api

# Pin to v3 to avoid mandatory Serverless API connectivity (v4).
frameworkVersion: '3'

useDotenv: true

custom:
  nodeEnv:
    dev: development
    prod: production

provider:
  name: aws
  runtime: nodejs20.x
  region: ${opt:region, 'ap-south-1'}
  stage: ${opt:stage, 'dev'}
  # DB + JSON parsing: 60s avoids cold start + query timeouts
  # Note: API Gateway HTTP API max timeout is 30s, but Lambda can be higher for internal processing
  timeout: 60
  # 512MB gives more CPU; increase to 1024 for list endpoints with large result sets
  memorySize: 512

  environment:
    NODE_ENV: ${self:custom.nodeEnv.${self:provider.stage}, 'development'}
    STAGE: ${self:provider.stage}
    MONGODB_URI: ${env:MONGODB_URI, ''}
    MONGODB_URI_STANDARD: ${env:MONGODB_URI_STANDARD, ''}
    MONGODB_DISCOVER_PRIMARY: 'false'
    # Production: set JWT_SECRET via env or SSM; do not use default in prod
    JWT_SECRET: ${env:JWT_SECRET, 'change-me'}
    JWT_EXPIRES_IN: ${env:JWT_EXPIRES_IN, '24h'}
    # S3 bucket for sketches, CAD drawings, audio, documents
    S3_BUCKET: ${env:S3_BUCKET, 'caddrawing'}

  httpApi:
    cors: true

  # S3: presigned URLs + multipart upload (bucket from S3_BUCKET env, default caddrawing)
  iamRoleStatements:
    - Effect: Allow
      Action:
        - s3:PutObject
        - s3:PutObjectAcl
      Resource: arn:aws:s3:::${env:S3_BUCKET, 'caddrawing'}/*
    - Effect: Allow
      Action:
        - s3:GetObject
      Resource: arn:aws:s3:::${env:S3_BUCKET, 'caddrawing'}/*
    - Effect: Allow
      Action:
        - s3:CreateMultipartUpload
        - s3:UploadPart
        - s3:CompleteMultipartUpload
        - s3:AbortMultipartUpload
      Resource: arn:aws:s3:::${env:S3_BUCKET, 'caddrawing'}/*
    - Effect: Allow
      Action:
        - s3:DeleteObject
      Resource: arn:aws:s3:::${env:S3_BUCKET, 'caddrawing'}/*

functions:
  authApi:
    handler: src/handlers/authApi.handler
    events:
      - httpApi:
          path: /api/auth/superadmin/register
          method: post
      - httpApi:
          path: /api/auth/surveyor/start
          method: post
      - httpApi:
          path: /api/auth/surveyor/verify-otp
          method: post
      - httpApi:
          path: /api/auth/surveyor/complete
          method: post
      - httpApi:
          path: /api/auth/login
          method: post
      - httpApi:
          path: /api/users
          method: post
      - httpApi:
          path: /api/users
          method: get
      - httpApi:
          path: /api/users/{userId}
          method: get
      - httpApi:
          path: /api/users/{userId}
          method: patch
      - httpApi:
          path: /api/users/{userId}
          method: delete
      - httpApi:
          path: /api/users/{userId}/block
          method: post
      - httpApi:
          path: /api/users/{userId}/unblock
          method: post
      - httpApi:
          path: /api/surveyor/sketch-uploads
          method: post
      - httpApi:
          path: /api/surveyor/sketch-uploads
          method: get
      - httpApi:
          path: /api/surveyor/sketch-uploads/{uploadId}
          method: get
      - httpApi:
          path: /api/admin/survey-sketch-statuses
          method: get
      - httpApi:
          path: /api/admin/survey-sketch-assignments
          method: post
      - httpApi:
          path: /api/admin/survey-sketch-assignments/{assignmentId}
          method: get
      - httpApi:
          path: /api/admin/survey-sketch-assignments/{assignmentId}
          method: patch
      - httpApi:
          path: /api/admin/cad-centers/{cadCenterId}/assignments
          method: get
      - httpApi:
          path: /api/cad/assignments/{assignmentId}/accept
          method: post

  testApi:
    handler: src/handlers/testApi.handler
    events:
      - httpApi:
          path: /test
          method: GET

  mastersApi:
    handler: src/handlers/mastersApi.handler
    events:
      - httpApi:
          path: /api/masters/districts
          method: post
      - httpApi:
          path: /api/masters/districts
          method: get
      - httpApi:
          path: /api/masters/districts/{districtId}
          method: get
      - httpApi:
          path: /api/masters/districts/{districtId}
          method: patch
      - httpApi:
          path: /api/masters/districts/{districtId}/talukas
          method: get
      - httpApi:
          path: /api/masters/talukas
          method: get
      - httpApi:
          path: /api/masters/talukas
          method: post
      - httpApi:
          path: /api/masters/talukas/{talukaId}
          method: get
      - httpApi:
          path: /api/masters/talukas/{talukaId}
          method: patch
      - httpApi:
          path: /api/masters/talukas/{talukaId}/hoblis
          method: get
      - httpApi:
          path: /api/masters/hoblis
          method: get
      - httpApi:
          path: /api/masters/hoblis
          method: post
      - httpApi:
          path: /api/masters/hoblis/{hobliId}
          method: get
      - httpApi:
          path: /api/masters/hoblis/{hobliId}
          method: patch
      - httpApi:
          path: /api/masters/hoblis/{hobliId}/villages
          method: get
      - httpApi:
          path: /api/masters/villages
          method: post
      - httpApi:
          path: /api/masters/villages
          method: get
      - httpApi:
          path: /api/masters/villages/{villageId}
          method: get
      - httpApi:
          path: /api/masters/villages/{villageId}
          method: patch
      - httpApi:
          path: /api/masters/cad-centers
          method: post
      - httpApi:
          path: /api/masters/cad-centers
          method: get
      - httpApi:
          path: /api/masters/cad-centers/{cadCenterId}
          method: get
      - httpApi:
          path: /api/masters/cad-centers/{cadCenterId}
          method: patch
      - httpApi:
          path: /api/masters/cad-centers/{cadCenterId}
          method: delete

  uploadApi:
    handler: src/handlers/uploadApi.handler
    events:
      - httpApi:
          path: /api/upload/image
          method: post
      - httpApi:
          path: /api/upload/audio
          method: post
      - httpApi:
          path: /api/upload/delete
          method: post

  swaggerApi:
    handler: src/handlers/swaggerApi.handler
    events:
      - httpApi:
          path: /api/docs
          method: GET
      - httpApi:
          path: /api/docs/swagger.yaml
          method: GET
      - httpApi:
          path: /api/docs/swagger.json
          method: GET
      - httpApi:
          path: /api/docs
          method: OPTIONS
      - httpApi:
          path: /api/docs/swagger.yaml
          method: OPTIONS
      - httpApi:
          path: /api/docs/swagger.json
          method: OPTIONS

plugins:
  - serverless-offline